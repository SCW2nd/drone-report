

<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ドローン飛行チェック</title>
<style>
body{font-family:system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Segoe UI", Roboto, sans-serif; padding:12px; max-width:900px; margin:auto; background:#fafafa; color:#111}
h1{font-size:20px; margin:8px 0}
.label{font-weight:600; margin-top:10px; display:block}
input[type="text"], input[type="date"], input[type="time"], textarea {width:100%; padding:10px; font-size:16px; box-sizing:border-box; margin-top:6px; border:1px solid #ccc; border-radius:6px; background:#fff}
.section{background:#fff; border:1px solid #e3e3e3; padding:10px; margin-top:10px; border-radius:8px}
.controls{display:flex; gap:8px; margin-top:12px}
button{flex:1; padding:12px; font-size:16px; border-radius:8px; border:0; background:#1976d2; color:#fff}
.small{font-size:13px; color:#666}
.radio-row{display:flex; gap:12px; flex-wrap:wrap; margin-top:6px}
@media (min-width:600px){ h1{font-size:24px} }
</style>
</head>
<body>
<h1>ドローン飛行チェック</h1>
<label class="label">日付
  <input id="date" type="date">
</label>
<label class="label">時間
  <input id="time" type="time">
</label>
<label class="label">操縦者
  <input id="operator" type="text" placeholder="名前">
</label>
<div id="formContainer"></div>
<div class="controls">
  <button id="saveBtn">送信</button>
</div>
<p class="small">送信するとスプレッドシートに記録されます。初回はネットワーク環境を確認してください。</p>
<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwXK5bosG6TXu1NoE-qMT_mF8qM6GWFlKvH9rx5HJhnxO6C4um-AlAse3xGcdzSrg_Wng/exec'; // ← ここを置換
const FORM_DEF_URL = ''; // optional
const fallbackFormItems = [
  {itemId:'pre_reg', label:'飛行する機体をドローン情報基盤システムに登録しましたか？', inputType:'radio', options:['はい','いいえ']},
  {itemId:'plan_report', label:'飛行計画をドローン情報基盤システムに通報（登録）しましたか？', inputType:'radio', options:['はい','いいえ']},
  {itemId:'health', label:'健康状態は良好ですか？', inputType:'radio', options:['はい','いいえ']},
  {itemId:'alcohol', label:'アルコールや薬物は摂取していませんか？', inputType:'radio', options:['はい','いいえ']},
  {itemId:'id_plate', label:'機体登録記号の確認（記載・汚れ・DIPS APPリモートID確認）', inputType:'radio', options:['はい','いいえ']},
  {itemId:'no_emergency_area', label:'飛行するエリアが緊急用務空域でないことを確認しましたか？', inputType:'radio', options:['はい','いいえ']}
];
let formItems = [];
async function loadFormDefinition(){
  if(FORM_DEF_URL){
    try{
      const r = await fetch(FORM_DEF_URL);
      if(!r.ok) throw new Error('フォーム定義取得失敗');
      const j = await r.json();
      formItems = j.items || fallbackFormItems;
      return;
    }catch(e){
      console.warn('FormDefinition fetch failed, use fallback', e);
      formItems = fallbackFormItems;
    }
  } else {
    formItems = fallbackFormItems;
  }
}
function buildForm(){
  const c = document.getElementById('formContainer');
  c.innerHTML = '';
  formItems.forEach(it=>{
    const s = document.createElement('div'); s.className='section';
    const title = document.createElement('div'); title.textContent = it.label; title.style.fontWeight='600';
    s.appendChild(title);
if(it.inputType === 'radio'){
  const row = document.createElement('div'); row.className='radio-row';
  it.options.forEach(opt=>{
    const lbl = document.createElement('label');
    lbl.style.cursor='pointer';
    lbl.innerHTML = `&lt;input type="radio" name="${it.itemId}" value="${opt}"&gt; ${opt}`;
    row.appendChild(lbl);
  });
  s.appendChild(row);
} else if(it.inputType === 'checkbox'){
  const lbl = document.createElement('label');
  lbl.innerHTML = `&lt;input type="checkbox" name="${it.itemId}" value="true"&gt; 該当`;
  s.appendChild(lbl);
} else {
  const inp = document.createElement('input'); inp.type='text'; inp.name = it.itemId;
  s.appendChild(inp);
}

const comment = document.createElement('input'); comment.type='text'; comment.name = it.itemId + '_comment';
comment.placeholder = 'コメント（任意）';
comment.style.marginTop = '8px';
s.appendChild(comment);

c.appendChild(s);
  });
}
function collectAnswers(){
  const answers = [];
  formItems.forEach(it=>{
    const name = it.itemId;
    let value = '';
    if(it.inputType === 'radio'){
      const sel = document.querySelector(input[name="${name}"]:checked);
      value = sel ? sel.value : '';
    } else if(it.inputType === 'checkbox'){
      const cb = document.querySelector(input[name="${name}"]);
      value = cb && cb.checked ? 'true' : '';
    } else {
      const inp = document.querySelector(input[name="${name}"]);
      value = inp ? inp.value : '';
    }
    const comment = (document.querySelector(input[name="${name}_comment"]) || {}).value || '';
    answers.push({itemId: name, value, comment});
  });
  return answers;
}
async function send(){
  if(!WEB_APP_URL || WEB_APP_URL.includes('<<')) { alert('WEB_APP_URL を設定してください'); return; }
  const date = document.getElementById('date').value || new Date().toISOString().slice(0,10);
  const time = document.getElementById('time').value || new Date().toTimeString().slice(0,5);
  const operator = document.getElementById('operator').value || '';
  const answers = collectAnswers();
  const payload = { date, time, operator, answers };
  try{
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    if(j && j.ok){ alert('保存しました'); }
    else { alert('保存に失敗しました'); console.log(j); }
  }catch(err){
    alert('送信エラー。ネットワークを確認してください。');
    console.error(err);
  }
}
document.getElementById('saveBtn').addEventListener('click', send);
(async ()=>{ await loadFormDefinition(); buildForm(); })();
</script>
</body>
</html>
